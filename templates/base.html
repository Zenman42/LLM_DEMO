<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {% if demo_mode %}<meta http-equiv="Cache-Control" content="no-store, no-cache">
    <meta name="description" content="LLM Tracker â€” SEO and AI visibility analytics dashboard with keyword rankings table.">
    <meta name="robots" content="noindex, nofollow">{% endif %}
    <title>{% block title %}LLM Tracker{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>
<body>
    <div class="app-layout">
        <!-- Mobile sidebar overlay -->
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-brand">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                </svg>
                <span class="sidebar-brand-text">LLM Tracker</span>
            </div>

            <nav class="sidebar-nav">
                <a href="/" class="nav-item{% if request.url.path == '/' %} active{% endif %}">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="7" height="7" rx="1"/>
                        <rect x="14" y="3" width="7" height="7" rx="1"/>
                        <rect x="3" y="14" width="7" height="7" rx="1"/>
                        <rect x="14" y="14" width="7" height="7" rx="1"/>
                    </svg>
                    <span class="nav-label">Dashboard</span>
                </a>
                <a href="/settings" class="nav-item{% if request.url.path == '/settings' %} active{% endif %}">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    <span class="nav-label">Settings</span>
                </a>
                <a href="/users" class="nav-item admin-only{% if request.url.path == '/users' %} active{% endif %}">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span class="nav-label">Users</span>
                </a>
                <a href="/api-keys" class="nav-item admin-only{% if request.url.path == '/api-keys' %} active{% endif %}">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                    </svg>
                    <span class="nav-label">API Keys</span>
                </a>
                <a href="/export" class="nav-item{% if request.url.path == '/export' %} active{% endif %}">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    <span class="nav-label">Export</span>
                </a>
                <a href="/account" class="nav-item{% if request.url.path == '/account' %} active{% endif %}">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    <span class="nav-label">Account</span>
                </a>
            </nav>

            {% if not demo_mode %}
            <div class="sidebar-footer">
                <a href="#" class="nav-item" onclick="logout(); return false;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    <span class="nav-label">Logout</span>
                </a>
            </div>
            {% endif %}
        </aside>

        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <button class="hamburger" onclick="toggleSidebar()" aria-label="Toggle sidebar">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="3" y1="12" x2="21" y2="12"/>
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <line x1="3" y1="18" x2="21" y2="18"/>
                    </svg>
                </button>
                <h1 class="page-title">{% block page_title %}Dashboard{% endblock %}</h1>
            </div>
            <div class="header-right">
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme" aria-label="Toggle theme">
                    <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                    </svg>
                    <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                </button>
                <a href="/project/new" class="btn btn-accent btn-sm">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    New Project
                </a>
                <button class="btn btn-primary btn-sm" onclick="collectAll()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="23 4 23 10 17 10"/>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                    </svg>
                    Collect All
                </button>
            </div>
        </header>

        <!-- Main content -->
        <main class="app-main">
            <div class="main-content">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <!-- Toast container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
    {% if demo_mode %}
    /* ---- Demo mode: no auth, data pre-rendered server-side ---- */
    var currentUserRole = 'admin';
    var currentUserProjectIds = [];
    var _roleLoaded = true;
    function waitForRole() { return Promise.resolve(); }
    function isAdmin() { return true; }
    function applyRoleRestrictions() {
        var items = document.querySelectorAll('.admin-only');
        for (var i = 0; i < items.length; i++) items[i].style.display = '';
    }
    async function apiFetch(url, options) {
        options = options || {};
        options.headers = Object.assign({}, options.headers || {}, { 'Content-Type': 'application/json' });
        return await fetch(url, options);
    }
    {% else %}
    /* ---- Auth helpers ---- */
    function getToken() {
        return localStorage.getItem('pt_access_token');
    }

    function authHeaders() {
        return { 'Authorization': 'Bearer ' + getToken(), 'Content-Type': 'application/json' };
    }

    function checkAuth() {
        if (!getToken()) {
            window.location.href = '/login';
        }
    }

    function logout() {
        localStorage.removeItem('pt_access_token');
        localStorage.removeItem('pt_refresh_token');
        window.location.href = '/login';
    }

    async function apiFetch(url, options) {
        options = options || {};
        options.headers = Object.assign({}, options.headers || {}, authHeaders());
        var resp = await fetch(url, options);
        if (resp.status === 401) {
            var refreshed = await tryRefresh();
            if (refreshed) {
                options.headers = Object.assign({}, options.headers || {}, authHeaders());
                resp = await fetch(url, options);
            } else {
                logout();
                return null;
            }
        }
        return resp;
    }

    async function tryRefresh() {
        var refreshToken = localStorage.getItem('pt_refresh_token');
        if (!refreshToken) return false;
        try {
            var resp = await fetch('/api/v1/auth/refresh', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ refresh_token: refreshToken }),
            });
            if (resp.ok) {
                var data = await resp.json();
                localStorage.setItem('pt_access_token', data.access_token);
                localStorage.setItem('pt_refresh_token', data.refresh_token);
                return true;
            }
        } catch (e) {}
        return false;
    }

    /* ---- Global role helpers ---- */
    var currentUserRole = null;
    var currentUserProjectIds = [];
    var _roleLoaded = false;

    async function loadCurrentUser() {
        try {
            var resp = await apiFetch('/api/v1/auth/me');
            if (resp && resp.ok) {
                var data = await resp.json();
                currentUserRole = data.role;
                currentUserProjectIds = data.project_ids || [];
                var localTheme = localStorage.getItem('pt_theme');
                if (data.theme && data.theme !== 'dark') {
                    applyTheme(data.theme);
                } else if (localTheme && localTheme !== 'dark' && data.theme === 'dark') {
                    applyTheme(localTheme);
                    apiFetch('/api/v1/account/theme', {
                        method: 'PATCH',
                        body: JSON.stringify({ theme: localTheme }),
                    });
                } else if (data.theme) {
                    applyTheme(data.theme);
                }
            } else {
                currentUserRole = 'viewer';
            }
        } catch (e) {
            currentUserRole = 'viewer';
        }
        _roleLoaded = true;
        applyRoleRestrictions();
    }
    {% endif %}

    {% if not demo_mode %}
    function waitForRole() {
        return new Promise(function(resolve) {
            if (_roleLoaded) return resolve();
            var attempts = 0;
            var check = function() {
                if (_roleLoaded) return resolve();
                if (++attempts > 100) { currentUserRole = currentUserRole || 'viewer'; _roleLoaded = true; return resolve(); }
                setTimeout(check, 50);
            };
            check();
        });
    }

    function isAdmin() {
        return currentUserRole === 'admin' || currentUserRole === 'owner';
    }

    function applyRoleRestrictions() {
        var adminItems = document.querySelectorAll('.admin-only');
        for (var i = 0; i < adminItems.length; i++) {
            adminItems[i].style.display = isAdmin() ? '' : 'none';
        }
    }
    {% endif %}

    /* ---- Toast notification system ---- */
    function showToast(message, type) {
        type = type || 'success';
        var container = document.getElementById('toastContainer');

        var toast = document.createElement('div');
        toast.className = 'toast toast-' + type;

        var icons = {
            success: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
            error: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
            warning: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
            info: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'
        };

        toast.innerHTML = '<div class="toast-icon">' + (icons[type] || icons.info) + '</div>'
            + '<div class="toast-message">' + message + '</div>'
            + '<button class="toast-close" onclick="dismissToast(this.parentElement)">'
            + '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>'
            + '</button>';

        container.appendChild(toast);

        // Auto-dismiss after 5 seconds
        setTimeout(function() { dismissToast(toast); }, 5000);
    }

    function dismissToast(toast) {
        if (!toast || !toast.parentElement) return;
        toast.classList.add('toast-exit');
        setTimeout(function() {
            if (toast.parentElement) toast.parentElement.removeChild(toast);
        }, 300);
    }

    // Alias for backward compatibility
    function showFlash(message, type) {
        showToast(message, type);
    }

    /* ---- Sidebar toggle ---- */
    function toggleSidebar() {
        var layout = document.querySelector('.app-layout');
        var overlay = document.querySelector('.sidebar-overlay');

        if (window.innerWidth < 768) {
            // Mobile: toggle overlay mode
            layout.classList.toggle('mobile-open');
        } else {
            // Desktop/tablet: toggle collapsed mode
            layout.classList.toggle('sidebar-collapsed');
            // Remember state
            localStorage.setItem('pt_sidebar_collapsed', layout.classList.contains('sidebar-collapsed') ? '1' : '0');
        }
    }

    // Restore sidebar state on load
    function restoreSidebarState() {
        if (window.innerWidth >= 768) {
            var collapsed = localStorage.getItem('pt_sidebar_collapsed');
            if (collapsed === '1') {
                document.querySelector('.app-layout').classList.add('sidebar-collapsed');
            }
        }
    }

    function collectAll() {
        if (!confirm('Start collection for all projects?')) return;
        apiFetch('/api/v1/collection/all', { method: 'POST' })
            .then(function(r) { return r ? r.json() : null; })
            .then(function(data) {
                if (data) showToast(data.message || 'Collection started');
            })
            .catch(function(e) { showToast('Error: ' + e, 'error'); });
    }

    /* ---- Theme management ---- */
    function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('pt_theme', theme);
    }

    function toggleTheme() {
        var current = document.documentElement.getAttribute('data-theme') || 'dark';
        var next = current === 'dark' ? 'light' : 'dark';
        applyTheme(next);
        // Persist to server (fire-and-forget)
        apiFetch('/api/v1/account/theme', {
            method: 'PATCH',
            body: JSON.stringify({ theme: next }),
        });
    }

    function restoreTheme() {
        // Immediate: use localStorage for instant apply (no FOUC)
        var cached = localStorage.getItem('pt_theme');
        if (cached) {
            document.documentElement.setAttribute('data-theme', cached);
        }
    }

    // Apply cached theme immediately (before DOMContentLoaded)
    restoreTheme();

    // Initialize
    {% if demo_mode %}
    restoreSidebarState();
    applyRoleRestrictions();
    {% else %}
    if (window.location.pathname !== '/login') {
        checkAuth();
        restoreSidebarState();
        loadCurrentUser();
    }
    {% endif %}
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>

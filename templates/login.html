<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Login â€” LLM Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="login-page">
    <button class="theme-toggle" onclick="toggleLoginTheme()" title="Toggle theme" aria-label="Toggle theme" style="position:fixed;top:16px;right:16px;z-index:100;">
        <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
        </svg>
        <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
        </svg>
    </button>
    <div class="login-box">
        <div class="login-brand">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
            </svg>
        </div>
        <h1>LLM Tracker</h1>
        <p class="login-subtitle" id="formSubtitle">Sign in to continue</p>
        <div class="login-error" id="loginError"></div>
        <form onsubmit="handleSubmit(event)">
            <div class="register-fields" id="registerFields">
                <label for="tenantName">Organization Name</label>
                <input type="text" id="tenantName" placeholder="My Company">
                <label for="tenantSlug">Organization Slug</label>
                <input type="text" id="tenantSlug" placeholder="my-company">
            </div>
            <label for="email">Email</label>
            <input type="email" id="email" name="email" autocomplete="email" autofocus required>
            <label for="password">Password</label>
            <input type="password" id="password" name="password" autocomplete="current-password" required>
            <button type="submit" class="btn-login" id="submitBtn">Sign In</button>
        </form>
        <a class="login-toggle" onclick="toggleMode()">
            <span id="toggleText">Don't have an account? Register</span>
        </a>
    </div>

    <script>
    // Restore theme from localStorage
    (function() {
        var t = localStorage.getItem('pt_theme');
        if (t) document.documentElement.setAttribute('data-theme', t);
    })();

    function toggleLoginTheme() {
        var current = document.documentElement.getAttribute('data-theme') || 'dark';
        var next = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('pt_theme', next);
    }

    var isRegister = false;

    function toggleMode() {
        isRegister = !isRegister;
        document.getElementById('registerFields').style.display = isRegister ? 'block' : 'none';
        document.getElementById('submitBtn').textContent = isRegister ? 'Register' : 'Sign In';
        document.getElementById('formSubtitle').textContent = isRegister ? 'Create your account' : 'Sign in to continue';
        document.getElementById('toggleText').textContent = isRegister
            ? 'Already have an account? Sign in'
            : "Don't have an account? Register";
    }

    async function handleSubmit(e) {
        e.preventDefault();
        var errEl = document.getElementById('loginError');
        errEl.style.display = 'none';

        var email = document.getElementById('email').value;
        var password = document.getElementById('password').value;

        try {
            var resp;
            if (isRegister) {
                var tenantName = document.getElementById('tenantName').value;
                var tenantSlug = document.getElementById('tenantSlug').value;
                if (!tenantName || !tenantSlug) {
                    errEl.textContent = 'Please fill in organization name and slug';
                    errEl.style.display = 'block';
                    return;
                }
                resp = await fetch('/api/v1/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        tenant_name: tenantName,
                        tenant_slug: tenantSlug,
                    }),
                });
            } else {
                resp = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email, password: password }),
                });
            }

            if (resp.ok) {
                var data = await resp.json();
                localStorage.setItem('pt_access_token', data.access_token);
                localStorage.setItem('pt_refresh_token', data.refresh_token);
                window.location.href = '/';
            } else {
                var err = await resp.json();
                errEl.textContent = err.detail || 'Authentication failed';
                errEl.style.display = 'block';
            }
        } catch (ex) {
            errEl.textContent = 'Connection error: ' + ex;
            errEl.style.display = 'block';
        }
    }

    // If already logged in, redirect to dashboard
    if (localStorage.getItem('pt_access_token')) {
        window.location.href = '/';
    }
    </script>
</body>
</html>

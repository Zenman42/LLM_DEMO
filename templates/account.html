{% extends "base.html" %}

{% block title %}Account â€” LLM Tracker{% endblock %}
{% block page_title %}Account{% endblock %}

{% block content %}

<!-- Profile Info -->
<div class="card">
    <h2>Profile</h2>
    <div id="profileInfo">Loading...</div>
</div>

<!-- Change Password -->
<div class="card">
    <h2>Change Password</h2>
    <form onsubmit="changePassword(event)" class="form-grid">
        <div class="form-group">
            <label>Current Password</label>
            <input type="password" id="currentPassword" required autocomplete="current-password">
        </div>
        <div class="form-group"></div>
        <div class="form-group">
            <label>New Password</label>
            <input type="password" id="newPassword" required minlength="8" autocomplete="new-password">
        </div>
        <div class="form-group">
            <label>Confirm New Password</label>
            <input type="password" id="confirmPassword" required minlength="8" autocomplete="new-password">
        </div>
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Change Password</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
async function loadAccount() {
    var resp = await apiFetch('/api/v1/account/me');
    if (!resp) return;
    var data = await resp.json();
    renderProfile(data);
}

function renderProfile(profile) {
    var container = document.getElementById('profileInfo');
    var html = '<div class="form-grid">';
    html += '<div class="form-group"><label>Email</label><p class="form-value">' + profile.email + '</p></div>';
    html += '<div class="form-group"><label>Role</label><p class="form-value"><span class="badge badge-active">' + profile.role.charAt(0).toUpperCase() + profile.role.slice(1) + '</span></p></div>';
    html += '<div class="form-group"><label>Organization</label><p class="form-value">' + profile.tenant_name + '</p></div>';
    html += '<div class="form-group"><label>Organization Slug</label><p class="form-value"><code>' + profile.tenant_slug + '</code></p></div>';
    html += '</div>';
    container.innerHTML = html;
}

async function changePassword(e) {
    e.preventDefault();
    var current = document.getElementById('currentPassword').value;
    var newPw = document.getElementById('newPassword').value;
    var confirmPw = document.getElementById('confirmPassword').value;

    if (newPw !== confirmPw) {
        showFlash('New passwords do not match', 'error');
        return;
    }

    var resp = await apiFetch('/api/v1/account/change-password', {
        method: 'POST',
        body: JSON.stringify({
            current_password: current,
            new_password: newPw,
        }),
    });
    if (resp && resp.ok) {
        var data = await resp.json();
        showFlash(data.message || 'Password changed');
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
    } else if (resp) {
        var err = await resp.json();
        showFlash(err.detail || 'Failed to change password', 'error');
    }
}

document.addEventListener('DOMContentLoaded', loadAccount);
</script>
{% endblock %}

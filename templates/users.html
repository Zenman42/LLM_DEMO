{% extends "base.html" %}

{% block title %}Users — LLM Tracker{% endblock %}
{% block page_title %}Users{% endblock %}

{% block content %}
<!-- Invite Form -->
<div class="card">
    <h2>Invite User</h2>
    <form onsubmit="inviteUser(event)" class="form-grid">
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="inviteEmail" required placeholder="user@example.com">
        </div>
        <div class="form-group">
            <label>Role</label>
            <select id="inviteRole" onchange="toggleInviteProjects()">
                <option value="viewer">Viewer</option>
                <option value="member" selected>Member</option>
                <option value="admin">Admin</option>
            </select>
        </div>
        <div class="form-group" id="inviteProjectsGroup">
            <label>Project Access</label>
            <div id="inviteProjectsList" class="checkbox-group"></div>
        </div>
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Send Invite</button>
        </div>
    </form>
</div>

<!-- Invite Result (temporary password) -->
<div class="card card-highlight" id="inviteResult" style="display:none;">
    <h2>Invite Sent</h2>
    <p>Temporary password for <strong id="invitedEmail"></strong>:</p>
    <div class="code-display">
        <code id="tempPassword"></code>
        <button class="btn btn-sm btn-primary" onclick="copyTempPassword()">Copy</button>
    </div>
    <p class="text-secondary text-sm">This password is shown only once. The user should change it after first login.</p>
</div>

<!-- Users Table -->
<div class="card">
    <h2>Team Members</h2>
    <div id="usersTable">Loading...</div>
</div>

<!-- Project Assignment Modal -->
<div id="projectModal" class="serp-modal-overlay" style="display:none;" onclick="if(event.target===this)closeProjectModal()">
    <div class="serp-modal" style="max-width:500px;">
        <div class="serp-modal-header">
            <h3 id="projectModalTitle">Assign Projects</h3>
            <button class="serp-modal-close" onclick="closeProjectModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <div class="serp-modal-body" style="padding:1.25rem;">
            <div id="projectModalBody"></div>
            <div style="margin-top:1rem;display:flex;gap:0.5rem;justify-content:flex-end;">
                <button class="btn btn-sm" onclick="closeProjectModal()">Cancel</button>
                <button class="btn btn-sm btn-primary" onclick="saveProjectAssignment()">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
var allProjects = [];
var editingUserId = null;

async function loadUsers() {
    // Load projects and users in parallel
    var [projResp, usersResp] = await Promise.all([
        apiFetch('/api/v1/projects/'),
        apiFetch('/api/v1/users/'),
    ]);

    if (projResp && projResp.ok) {
        var projData = await projResp.json();
        allProjects = projData;
        renderInviteProjects();
    }

    if (usersResp && usersResp.ok) {
        var data = await usersResp.json();
        renderUsersTable(data.items);
    }
}

function renderInviteProjects() {
    var container = document.getElementById('inviteProjectsList');
    if (!allProjects || allProjects.length === 0) {
        container.innerHTML = '<p class="muted">No projects yet.</p>';
        return;
    }
    var html = '';
    allProjects.forEach(function(p) {
        html += '<label><input type="checkbox" class="invite-proj-cb" value="' + p.id + '"> ' + escapeHtml(p.name) + '</label>';
    });
    container.innerHTML = html;
    toggleInviteProjects();
}

function escapeHtml(s) {
    var d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
}

function escapeAttr(s) {
    return String(s).replace(/&/g,'&amp;').replace(/'/g,'&#39;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function toggleInviteProjects() {
    var role = document.getElementById('inviteRole').value;
    var group = document.getElementById('inviteProjectsGroup');
    // Show project selection for viewer/member; admin gets all projects
    group.style.display = (role === 'admin') ? 'none' : '';
}

function getProjectName(projectId) {
    for (var i = 0; i < allProjects.length; i++) {
        if (allProjects[i].id === projectId) return allProjects[i].name;
    }
    return 'Project #' + projectId;
}

function renderUsersTable(users) {
    var container = document.getElementById('usersTable');
    if (!users || users.length === 0) {
        container.innerHTML = '<p class="muted">No users found.</p>';
        return;
    }

    var html = '<div class="table-wrapper"><table class="keywords-table"><thead><tr>';
    html += '<th>Email</th><th>Role</th><th>Projects</th><th>Status</th><th>Created</th><th>Actions</th>';
    html += '</tr></thead><tbody>';

    users.forEach(function(u) {
        html += '<tr>';
        html += '<td>' + escapeHtml(u.email) + '</td>';
        html += '<td>';
        if (u.role === 'owner') {
            html += '<span class="badge badge-active">Owner</span>';
        } else {
            html += '<select onchange="changeRole(\'' + u.id + '\', this.value)">';
            ['viewer', 'member', 'admin'].forEach(function(r) {
                html += '<option value="' + r + '"' + (u.role === r ? ' selected' : '') + '>';
                html += r.charAt(0).toUpperCase() + r.slice(1) + '</option>';
            });
            html += '</select>';
        }
        html += '</td>';

        // Projects column
        html += '<td>';
        if (u.role === 'admin' || u.role === 'owner') {
            html += '<span class="badge badge-active">All projects</span>';
        } else {
            var pids = u.project_ids || [];
            if (pids.length === 0) {
                html += '<span class="muted">None</span>';
            } else {
                var names = pids.map(function(pid) { return escapeHtml(getProjectName(pid)); });
                html += '<span title="' + names.join(', ') + '">' + pids.length + ' project' + (pids.length !== 1 ? 's' : '') + '</span>';
            }
            html += ' <button class="btn btn-sm" onclick="openProjectModal(\'' + u.id + '\', \'' + escapeAttr(u.email) + '\', ' + JSON.stringify(pids) + ')">Edit</button>';
        }
        html += '</td>';

        html += '<td><span class="badge ' + (u.is_active ? 'badge-active' : 'badge-inactive') + '">';
        html += (u.is_active ? 'Active' : 'Inactive') + '</span></td>';
        html += '<td>' + (u.created_at ? u.created_at.split('T')[0] : '—') + '</td>';
        html += '<td>';
        if (u.role !== 'owner' && u.is_active) {
            html += '<button class="btn btn-sm btn-danger" onclick="deactivateUser(\'' + u.id + '\', \'' + escapeAttr(u.email) + '\')">Deactivate</button>';
        }
        html += '</td>';
        html += '</tr>';
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

async function inviteUser(e) {
    e.preventDefault();
    var email = document.getElementById('inviteEmail').value;
    var role = document.getElementById('inviteRole').value;

    var projectIds = [];
    if (role !== 'admin') {
        document.querySelectorAll('.invite-proj-cb:checked').forEach(function(cb) {
            projectIds.push(parseInt(cb.value));
        });
    }

    var resp = await apiFetch('/api/v1/users/invite', {
        method: 'POST',
        body: JSON.stringify({ email: email, role: role, project_ids: projectIds }),
    });
    if (resp && resp.ok) {
        var data = await resp.json();
        document.getElementById('invitedEmail').textContent = data.email;
        document.getElementById('tempPassword').textContent = data.temporary_password;
        document.getElementById('inviteResult').style.display = '';
        document.getElementById('inviteEmail').value = '';
        // Uncheck all project checkboxes
        document.querySelectorAll('.invite-proj-cb').forEach(function(cb) { cb.checked = false; });
        showFlash('User invited successfully');
        loadUsers();
    } else if (resp) {
        var err = await resp.json();
        showFlash(err.detail || 'Failed to invite user', 'error');
    }
}

function copyTempPassword() {
    var pw = document.getElementById('tempPassword').textContent;
    navigator.clipboard.writeText(pw).then(function() {
        showFlash('Password copied to clipboard');
    });
}

async function changeRole(userId, newRole) {
    var resp = await apiFetch('/api/v1/users/' + userId + '/role', {
        method: 'PATCH',
        body: JSON.stringify({ role: newRole }),
    });
    if (resp && resp.ok) {
        showFlash('Role updated');
        loadUsers();
    } else if (resp) {
        var err = await resp.json();
        showFlash(err.detail || 'Failed to update role', 'error');
        loadUsers();
    }
}

async function deactivateUser(userId, email) {
    if (!confirm('Deactivate user ' + email + '?')) return;
    var resp = await apiFetch('/api/v1/users/' + userId, { method: 'DELETE' });
    if (resp && resp.ok) {
        showFlash('User deactivated');
        loadUsers();
    } else if (resp) {
        var err = await resp.json();
        showFlash(err.detail || 'Failed to deactivate', 'error');
    }
}

/* ---- Project Assignment Modal ---- */
function openProjectModal(userId, email, currentPids) {
    editingUserId = userId;
    document.getElementById('projectModalTitle').textContent = 'Projects for ' + email;
    var body = document.getElementById('projectModalBody');

    if (!allProjects || allProjects.length === 0) {
        body.innerHTML = '<p class="muted">No projects available.</p>';
    } else {
        var html = '<div class="checkbox-group" style="max-height:400px;overflow-y:auto;">';
        allProjects.forEach(function(p) {
            var checked = currentPids.indexOf(p.id) !== -1 ? ' checked' : '';
            html += '<label style="display:block;padding:0.35rem 0;"><input type="checkbox" class="modal-proj-cb" value="' + p.id + '"' + checked + '> ' + escapeHtml(p.name) + '</label>';
        });
        html += '</div>';
        body.innerHTML = html;
    }

    document.getElementById('projectModal').style.display = '';
}

function closeProjectModal() {
    document.getElementById('projectModal').style.display = 'none';
    editingUserId = null;
}

async function saveProjectAssignment() {
    if (!editingUserId) return;
    var projectIds = [];
    document.querySelectorAll('.modal-proj-cb:checked').forEach(function(cb) {
        projectIds.push(parseInt(cb.value));
    });

    var resp = await apiFetch('/api/v1/users/' + editingUserId + '/projects', {
        method: 'PUT',
        body: JSON.stringify({ project_ids: projectIds }),
    });
    if (resp && resp.ok) {
        showFlash('Project access updated');
        closeProjectModal();
        loadUsers();
    } else if (resp) {
        var err = await resp.json();
        showFlash(err.detail || 'Failed to update projects', 'error');
    }
}

document.addEventListener('DOMContentLoaded', loadUsers);
</script>
{% endblock %}

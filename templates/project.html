{% extends "base.html" %}

{% block title %}{{ demo_project.name if demo_mode and demo_project else 'Project' }} — LLM Tracker{% endblock %}
{% block page_title %}{{ demo_project.name if demo_mode and demo_project else 'Project' }}{% endblock %}

{% block content %}
{% if demo_mode and demo_project %}
{# ---- Server-side rendered content for tools that don't execute JS ---- #}
<div id="projectContent">
    <div class="project-header"><div>
        <span class="domain-label">{{ demo_project.domain }}</span>
        <span class="badge">{{ demo_project.search_engine }}</span>
        {% if demo_project.track_llm %}<span class="badge" style="background:var(--accent);color:#fff;margin-left:6px;">LLM</span>{% endif %}
    </div>
    <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn btn-primary">Collect SERP</button>
        {% if demo_project.track_llm %}<button class="btn btn-primary" style="background:#805ad5;">Collect LLM</button>{% endif %}
        <a href="/project/{{ demo_project.id }}/settings" class="btn" style="padding:6px 10px;font-size:16px;" title="Project Settings">⚙</a>
    </div></div>

    {% if demo_project.track_llm %}
    <div class="main-tabs-bar">
        <button class="main-tab-btn active">LLM Visibility</button>
        <button class="main-tab-btn">SERP: POS + AI</button>
    </div>
    {% endif %}

    {# Keywords Table #}
    {% if demo_keywords %}
    <div class="engine-section">
        <h2 class="engine-title {{ 'google-title' if demo_engine == 'google' else 'yandex-title' }}">Keywords</h2>
        <div class="table-wrapper"><table class="keywords-table"><thead><tr>
            <th>Keyword</th>
            <th>Position</th>
            <th>Change</th>
            <th>Found URL</th>
            <th>Match</th>
            <th>SERP</th>
        </tr></thead><tbody>
        {% for kw in demo_keywords %}
        <tr>
            <td><code>{{ kw.keyword }}</code></td>
            <td>{% if kw.position and kw.position > 0 %}<span class="pos-badge {{ 'top3' if kw.position <= 3 else 'good' if kw.position <= 10 else 'medium' if kw.position <= 30 else 'poor' }}">{{ kw.position }}</span>{% else %}<span class="muted">50+</span>{% endif %}</td>
            <td>{% if kw.change is not none %}{% if kw.change > 0 %}<span class="change-up">+{{ kw.change }}</span>{% elif kw.change < 0 %}<span class="change-down">{{ kw.change }}</span>{% else %}<span class="change-none">—</span>{% endif %}{% else %}<span class="muted">—</span>{% endif %}</td>
            <td class="url-cell" title="{{ kw.found_url or '' }}">{{ (kw.found_url or '—')[:60] }}{% if kw.found_url and kw.found_url|length > 60 %}...{% endif %}</td>
            <td>{% if kw.match == true %}<span class="match-ok">OK</span>{% elif kw.match == false %}<span class="match-no">X</span>{% else %}<span class="muted">—</span>{% endif %}</td>
            <td><button class="btn btn-sm btn-serp">TOP</button></td>
        </tr>
        {% endfor %}
        </tbody></table></div>
    </div>
    {% else %}
    <div class="empty-state"><p>No keywords tracked. <a href="/settings">Add keywords</a> in settings.</p></div>
    {% endif %}
</div>
{% else %}
<div id="projectContent">
    <div class="empty-state"><p>Loading...</p></div>
</div>
{% endif %}

{% if not demo_mode %}
<!-- SERP Modal -->
<div id="serpModal" class="serp-modal-overlay" style="display:none;" onclick="closeModalOverlay(event, 'serpModal')">
    <div class="serp-modal">
        <div class="serp-modal-header">
            <h3 id="serpModalTitle">SERP Top</h3>
            <button class="serp-modal-close" onclick="closeModal('serpModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <div class="serp-modal-meta" id="serpModalMeta"></div>
        <div class="serp-modal-body" id="serpModalBody">
            <p class="muted">Loading...</p>
        </div>
    </div>
</div>

<!-- GSC Modal -->
<div id="gscModal" class="serp-modal-overlay" style="display:none;" onclick="closeModalOverlay(event, 'gscModal')">
    <div class="serp-modal">
        <div class="serp-modal-header">
            <h3 id="gscModalTitle">GSC Data</h3>
            <button class="serp-modal-close" onclick="closeModal('gscModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <div class="serp-modal-meta" id="gscModalMeta"></div>
        <div class="serp-modal-body" id="gscModalBody">
            <p class="muted">Loading...</p>
        </div>
    </div>
</div>

<!-- LLM Response Modal -->
<div id="llmResponseModal" class="serp-modal-overlay" style="display:none;" onclick="closeModalOverlay(event, 'llmResponseModal')">
    <div class="serp-modal" style="max-width:800px;">
        <div class="serp-modal-header">
            <h3 id="llmResponseModalTitle">LLM Response</h3>
            <button class="serp-modal-close" onclick="closeModal('llmResponseModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <div class="serp-modal-meta" id="llmResponseModalMeta"></div>
        <div class="serp-modal-body" id="llmResponseModalBody" style="max-height:60vh; overflow-y:auto;">
            <p class="muted">Loading...</p>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if not demo_mode %}
<script>
/* ---- Chart.js dark theme defaults ---- */
Chart.defaults.color = '#a0aec0';
Chart.defaults.borderColor = '#2d3748';
Chart.defaults.plugins.tooltip.backgroundColor = '#1a1f2e';
Chart.defaults.plugins.tooltip.borderColor = '#2d3748';
Chart.defaults.plugins.tooltip.borderWidth = 1;
Chart.defaults.plugins.tooltip.titleColor = '#e2e8f0';
Chart.defaults.plugins.tooltip.bodyColor = '#a0aec0';
Chart.defaults.plugins.tooltip.padding = 12;
Chart.defaults.plugins.tooltip.cornerRadius = 8;
Chart.defaults.plugins.legend.labels.color = '#a0aec0';

const PROJECT_ID = {{ project_id }};
let projectData = null;
let kwData = null;
let allUrls = [];
let currentEngine = 'google';
let currentMainTab = 'llm'; // 'llm' or 'serp'
let llmDashData = null;
let llmChartInstance = null;
let currentCategory = '';
let sovDetailLevel = '';
let currentSovProvider = '';

async function loadProject() {
    // Load project info
    var resp = await apiFetch('/api/v1/projects/' + PROJECT_ID);
    if (!resp) return;
    if (resp.status === 404) {
        document.getElementById('projectContent').innerHTML = '<div class="empty-state"><p>Project not found.</p></div>';
        return;
    }
    projectData = await resp.json();

    // Update page title with project name
    var titleEl = document.querySelector('.page-title');
    if (titleEl) titleEl.textContent = projectData.name;
    document.title = projectData.name + ' — LLM Tracker';

    var hasGoogle = projectData.search_engine === 'google' || projectData.search_engine === 'both';
    var hasYandex = projectData.search_engine === 'yandex' || projectData.search_engine === 'both';
    currentEngine = hasGoogle ? 'google' : 'yandex';

    // Load keywords with positions for default engine
    await loadKeywords(currentEngine);
}

async function loadKeywords(engine) {
    var resp = await apiFetch('/api/v1/serp/project-keywords/' + PROJECT_ID + '?engine=' + engine);
    if (!resp) return;
    kwData = await resp.json();
    allUrls = kwData.all_urls || [];
    renderProject();
}

function renderProject() {
    if (!projectData || !kwData) return;
    var p = projectData;
    var hasGoogle = p.search_engine === 'google' || p.search_engine === 'both';
    var hasYandex = p.search_engine === 'yandex' || p.search_engine === 'both';
    var hasLlm = p.track_llm;

    var html = '';

    // Header
    html += '<div class="project-header"><div>';
    html += '<span class="domain-label">' + (p.domain || '') + '</span>';
    html += '<span class="badge">' + p.search_engine + '</span>';
    if (hasLlm) html += '<span class="badge" style="background:var(--accent);color:#fff;margin-left:6px;">LLM</span>';
    html += '</div>';
    html += '<div style="display:flex;gap:8px;align-items:center;">';
    html += '<button class="btn btn-primary" onclick="collectProject()">Collect SERP</button>';
    if (hasLlm) html += '<button class="btn btn-primary" onclick="collectLlm()" style="background:#805ad5;">Collect LLM</button>';
    html += '<a href="/project/' + p.id + '/settings" class="btn" style="padding:6px 10px;font-size:16px;" title="Project Settings">⚙</a>';
    html += '</div></div>';

    // Main section tabs (SERP vs LLM)
    if (hasLlm) {
        html += '<div class="main-tabs-bar">';
        html += '<button class="main-tab-btn' + (currentMainTab === 'llm' ? ' active' : '') + '" onclick="switchMainTab(\'llm\')">LLM Visibility</button>';
        html += '<button class="main-tab-btn' + (currentMainTab === 'serp' ? ' active' : '') + '" onclick="switchMainTab(\'serp\')">SERP: POS + AI</button>';
        html += '</div>';
    }

    // SERP section wrapper
    html += '<div id="serpSection" style="' + (currentMainTab !== 'serp' ? 'display:none;' : '') + '">';

    if (!kwData.keywords || kwData.keywords.length === 0) {
        html += '<div class="empty-state"><p>No keywords tracked. <a href="/settings">Add keywords</a> in settings.</p></div>';
    } else {

    // URL Filter
    html += '<div class="url-filter-bar"><div class="url-filter-form">';
    html += '<div class="filter-group"><label>Page</label>';
    html += '<select id="pageUrlSelect" onchange="applyUrlFilter()">';
    html += '<option value="">-- All pages --</option>';
    allUrls.forEach(function(u) {
        var display = u.length > 80 ? u.substring(0, 80) + '...' : u;
        html += '<option value="' + u + '">' + display + '</option>';
    });
    html += '</select></div>';
    html += '</div></div>';

    // Tabs
    html += '<div class="tabs-container"><div class="tabs-header">';
    if (hasGoogle) html += '<button class="tab-btn' + (currentEngine === 'google' ? ' active' : '') + '" onclick="switchTab(\'google\')" id="tabBtnGoogle">Google</button>';
    if (hasYandex) html += '<button class="tab-btn' + (currentEngine === 'yandex' ? ' active' : '') + '" onclick="switchTab(\'yandex\')" id="tabBtnYandex">Yandex</button>';
    html += '</div>';

    // Tab content
    html += '<div class="tab-content active" id="tabContent">';

    // Chart
    html += '<div class="chart-section"><h2>Position History</h2>';
    html += '<div class="chart-controls">';
    html += '<div class="chart-mode-toggle">';
    html += '<label><input type="radio" name="chartMode" value="keyword" checked onchange="toggleChartMode()"> Keyword</label>';
    html += '<label><input type="radio" name="chartMode" value="url" onchange="toggleChartMode()"> URL</label>';
    html += '</div>';
    html += '<select id="chartKeywordSelect" class="chart-select" onchange="loadChart()">';
    kwData.keywords.forEach(function(kw) {
        html += '<option value="' + kw.keyword_id + '">' + kw.keyword + '</option>';
    });
    html += '</select>';
    html += '<select id="chartUrlSelect" class="chart-select" style="display:none;" onchange="onUrlSelectChange()">';
    allUrls.forEach(function(u) {
        var display = u.length > 80 ? u.substring(0, 80) + '...' : u;
        html += '<option value="' + u + '">' + display + '</option>';
    });
    html += '</select>';
    html += '<select id="daysSelect" onchange="loadChart()">';
    html += '<option value="7">7 days</option><option value="30" selected>30 days</option><option value="90">90 days</option>';
    html += '</select></div>';
    html += '<div id="urlKeywordsList" class="url-keywords-list" style="display:none;"></div>';
    html += '<div class="chart-container"><canvas id="positionChart"></canvas></div>';
    html += '</div>';

    // Keywords table
    html += renderKeywordsTable(kwData.keywords, currentEngine);

    // GSC Semantics (Google only)
    if (currentEngine === 'google') {
        html += '<div class="engine-section">';
        html += '<div class="engine-section-header">';
        html += '<h2 class="engine-title gsc-sem-title">GSC Semantics</h2>';
        html += '<button class="btn btn-sm btn-primary" id="gscSemBtn" onclick="loadGscSemantics()">Load</button></div>';
        html += '<div id="gscSemanticsBody"><p class="muted">Additional queries from GSC on tracked pages. Click "Load" to fetch.</p></div>';
        html += '</div>';
    }

    html += '</div></div>';

    } // end if keywords exist
    html += '</div>'; // close #serpSection

    // LLM Visibility section
    if (hasLlm) {
        html += '<div id="llmSection" style="' + (currentMainTab !== 'llm' ? 'display:none;' : '') + '">';
        html += '<div id="llmContent"><div class="empty-state"><p>Loading LLM data...</p></div></div>';
        html += '</div>';
    }

    document.getElementById('projectContent').innerHTML = html;
    initSortable();
    if (currentMainTab === 'llm' && hasLlm) loadLlmSection();
    if (currentMainTab === 'serp') loadChart();
}

function renderKeywordsTable(keywords, engine) {
    var isGoogle = engine === 'google';
    var html = '<div class="engine-section">';
    html += '<h2 class="engine-title ' + (isGoogle ? 'google-title' : 'yandex-title') + '">Keywords</h2>';
    html += '<div class="table-wrapper"><table class="keywords-table sortable" id="kwTable"><thead><tr>';
    html += '<th data-sort="string">Keyword</th>';
    html += '<th data-sort="number">Position</th>';
    html += '<th data-sort="number">Change</th>';
    html += '<th data-sort="string">Found URL</th>';
    html += '<th data-sort="string">Match</th>';
    html += '<th>SERP</th>';
    if (isGoogle) {
        html += '<th data-sort="number">GSC Pos</th>';
        html += '<th data-sort="number" data-sort-default="desc">Imp</th>';
        html += '<th data-sort="number">Clicks</th>';
        html += '<th data-sort="number">CTR</th>';
        html += '<th></th>';
    }
    html += '</tr></thead><tbody>';

    keywords.forEach(function(kw) {
        var pos = kw.position;
        var change = kw.change;
        var foundUrl = kw.found_url || '';
        var displayUrl = foundUrl.length > 60 ? foundUrl.substring(0, 60) + '...' : foundUrl;

        html += '<tr>';
        html += '<td data-sort-value="' + kw.keyword + '"><code>' + kw.keyword + '</code></td>';

        // Position
        html += '<td data-sort-value="' + (pos && pos > 0 ? pos : 999) + '">';
        if (pos && pos > 0) {
            var posClass = pos <= 3 ? 'top3' : pos <= 10 ? 'good' : pos <= 30 ? 'medium' : 'poor';
            html += '<span class="pos-badge ' + posClass + '">' + pos + '</span>';
        } else {
            html += '<span class="muted">50+</span>';
        }
        html += '</td>';

        // Change
        html += '<td data-sort-value="' + (change !== null && change !== undefined ? change : -9999) + '">';
        if (change !== null && change !== undefined) {
            if (change > 0) html += '<span class="change-up">+' + change + '</span>';
            else if (change < 0) html += '<span class="change-down">' + change + '</span>';
            else html += '<span class="change-none">—</span>';
        } else {
            html += '<span class="muted">—</span>';
        }
        html += '</td>';

        // Found URL
        html += '<td class="url-cell" title="' + foundUrl + '" data-sort-value="' + foundUrl + '">' + (displayUrl || '—') + '</td>';

        // Match
        html += '<td data-sort-value="' + (kw.match === true ? 1 : 0) + '">';
        if (kw.match === true) html += '<span class="match-ok">OK</span>';
        else if (kw.match === false) html += '<span class="match-no">X</span>';
        else html += '<span class="muted">—</span>';
        html += '</td>';

        // SERP button
        html += '<td><button class="btn btn-sm btn-serp" onclick="showSerp(' + kw.keyword_id + ', \'' + engine + '\')" title="Show SERP top-50">TOP</button></td>';

        // GSC columns (Google only)
        if (isGoogle) {
            var gscPos = kw.gsc_position;
            html += '<td data-sort-value="' + (gscPos || 999) + '">';
            if (gscPos) {
                var gPosClass = gscPos <= 3 ? 'top3' : gscPos <= 10 ? 'good' : gscPos <= 30 ? 'medium' : 'poor';
                html += '<span class="pos-badge ' + gPosClass + '">' + gscPos + '</span>';
            } else {
                html += '<span class="muted">—</span>';
            }
            html += '</td>';

            html += '<td data-sort-value="' + (kw.gsc_impressions || 0) + '">' + (kw.gsc_impressions ? kw.gsc_impressions.toLocaleString() : '—') + '</td>';
            html += '<td data-sort-value="' + (kw.gsc_clicks || 0) + '">' + (kw.gsc_clicks ? kw.gsc_clicks.toLocaleString() : '—') + '</td>';
            html += '<td data-sort-value="' + (kw.gsc_ctr || -1) + '">';
            if (kw.gsc_impressions) html += kw.gsc_ctr.toFixed(1) + '%';
            else html += '<span class="muted">—</span>';
            html += '</td>';

            html += '<td><button class="btn btn-sm btn-gsc" onclick="showGsc(' + kw.keyword_id + ')" title="GSC data by day">GSC</button></td>';
        }

        html += '</tr>';
    });

    html += '</tbody></table></div></div>';
    return html;
}

/* ---- Tab switching ---- */
function switchTab(engine) {
    currentEngine = engine;
    document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
    var btn = document.getElementById('tabBtn' + engine.charAt(0).toUpperCase() + engine.slice(1));
    if (btn) btn.classList.add('active');
    loadKeywords(engine);
}

/* ---- URL filter ---- */
function applyUrlFilter() {
    var url = document.getElementById('pageUrlSelect').value;
    if (url) {
        // Reload with filter
        apiFetch('/api/v1/serp/project-keywords/' + PROJECT_ID + '?engine=' + currentEngine + '&page_url=' + encodeURIComponent(url))
            .then(function(r) { return r ? r.json() : null; })
            .then(function(data) {
                if (data) {
                    kwData = data;
                    renderProject();
                    // Restore filter selection
                    var sel = document.getElementById('pageUrlSelect');
                    if (sel) sel.value = url;
                }
            });
    } else {
        loadKeywords(currentEngine);
    }
}

/* ---- Chart ---- */
let chartInstances = {};

function toggleChartMode() {
    var mode = document.querySelector('input[name="chartMode"]:checked').value;
    document.getElementById('chartKeywordSelect').style.display = mode === 'keyword' ? '' : 'none';
    document.getElementById('chartUrlSelect').style.display = mode === 'url' ? '' : 'none';
    var kwList = document.getElementById('urlKeywordsList');
    if (mode === 'keyword') {
        kwList.style.display = 'none';
        loadChart();
    } else {
        onUrlSelectChange();
    }
}

async function onUrlSelectChange() {
    var urlSel = document.getElementById('chartUrlSelect');
    if (!urlSel || !urlSel.value) return;
    var container = document.getElementById('urlKeywordsList');
    container.innerHTML = '<span class="muted">Loading...</span>';
    container.style.display = '';

    var resp = await apiFetch('/api/v1/serp/url-keywords/' + PROJECT_ID +
        '?page_url=' + encodeURIComponent(urlSel.value) + '&engine=' + currentEngine);
    if (!resp) return;
    var data = await resp.json();

    if (!data.keywords || !data.keywords.length) {
        container.innerHTML = '<span class="muted">No keywords found for this URL</span>';
        clearChart();
        return;
    }
    container.style.display = '';
    var html = data.keywords.map(function(kw) {
        return '<label class="url-kw-item">' +
            '<input type="checkbox" value="' + kw.id + '" onchange="loadChart()">' +
            '<code>' + kw.keyword + '</code>' +
            '<span class="url-kw-imp">(' + kw.impressions.toLocaleString() + ')</span></label>';
    }).join('');
    container.innerHTML = html;
    clearChart();
}

function clearChart() {
    if (chartInstances[currentEngine]) {
        chartInstances[currentEngine].destroy();
        chartInstances[currentEngine] = null;
    }
}

/* Brighter palette optimized for dark background */
const COLORS = [
    '#60a5fa', '#34d399', '#fb923c', '#a78bfa',
    '#f87171', '#2dd4bf', '#fbbf24', '#818cf8',
    '#fb7185', '#4ade80', '#fdba74', '#c084fc',
];

async function loadChart() {
    var mode = document.querySelector('input[name="chartMode"]:checked');
    mode = mode ? mode.value : 'keyword';
    var days = document.getElementById('daysSelect');
    days = days ? days.value : '30';

    var params = new URLSearchParams({ days: days, engine: currentEngine, mode: mode });

    if (mode === 'keyword') {
        var sel = document.getElementById('chartKeywordSelect');
        if (sel && sel.value) params.set('keyword_id', sel.value);
        else return;
    } else {
        var checks = document.querySelectorAll('#urlKeywordsList input[type="checkbox"]:checked');
        var ids = Array.from(checks).map(function(c) { return c.value; });
        if (!ids.length) { clearChart(); return; }
        params.set('keyword_ids', ids.join(','));
    }

    var resp = await apiFetch('/api/v1/serp/chart/' + PROJECT_ID + '?' + params);
    if (!resp) return;
    var data = await resp.json();

    clearChart();
    var ctx = document.getElementById('positionChart');
    if (!ctx) return;

    var colorIndex = 0;
    var datasets = data.datasets.map(function(ds) {
        var isGsc = ds.type === 'gsc';
        var color = isGsc ? COLORS[(colorIndex - 1 + COLORS.length) % COLORS.length] : COLORS[colorIndex % COLORS.length];
        if (!isGsc) colorIndex++;
        return {
            label: ds.label, data: ds.data, borderColor: color, backgroundColor: color + '20',
            fill: false, tension: 0.3, pointRadius: isGsc ? 2 : 3, pointHoverRadius: isGsc ? 4 : 6,
            borderWidth: 2, borderDash: isGsc ? [6, 3] : [], spanGaps: true,
        };
    });

    var allValues = [];
    datasets.forEach(function(ds) { ds.data.forEach(function(v) { if (v !== null) allValues.push(v); }); });
    var yMin = 1, yMax = 10;
    if (allValues.length > 0) {
        var dataMin = Math.min.apply(null, allValues);
        var dataMax = Math.max.apply(null, allValues);
        yMin = Math.max(0, Math.floor(dataMin) - 2);
        yMax = Math.ceil(dataMax) + 2;
        if (yMax - yMin < 5) yMax = yMin + 5;
    }
    var yStep = (yMax - yMin) <= 15 ? 1 : (yMax - yMin) <= 40 ? 5 : 10;

    chartInstances[currentEngine] = new Chart(ctx, {
        type: 'line',
        data: { labels: data.labels, datasets: datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
                y: {
                    reverse: true, min: yMin, max: yMax,
                    title: { display: true, text: 'Position', color: '#a0aec0' },
                    ticks: { stepSize: yStep, color: '#a0aec0' },
                    grid: { color: '#2d3748' },
                },
                x: {
                    title: { display: true, text: 'Date', color: '#a0aec0' },
                    ticks: { maxRotation: 45, maxTicksLimit: 15, color: '#a0aec0' },
                    grid: { color: '#2d3748' },
                },
            },
            plugins: {
                tooltip: { mode: 'index', intersect: false, callbacks: {
                    label: function(ctx) { var pos = ctx.parsed.y; return pos === null ? ctx.dataset.label + ': no data' : ctx.dataset.label + ': #' + pos; },
                }},
                legend: { position: 'bottom', labels: { boxWidth: 20, boxHeight: 2, padding: 15, font: { size: 12 }, color: '#a0aec0' } },
            },
            interaction: { mode: 'index', intersect: false },
        },
    });
}

/* ---- Table Sorting ---- */
function initSortable() {
    document.querySelectorAll('table.sortable').forEach(function(table) {
        var headers = table.querySelectorAll('th[data-sort]');
        headers.forEach(function(th) {
            th.classList.add('sortable-th');
            th.addEventListener('click', function() {
                var sortType = th.getAttribute('data-sort');
                var tbody = table.querySelector('tbody');
                var rows = Array.from(tbody.querySelectorAll('tr'));
                var currentDir = th.getAttribute('data-sort-dir');
                var newDir;
                if (!currentDir) {
                    newDir = th.hasAttribute('data-sort-default') ? th.getAttribute('data-sort-default') : 'asc';
                } else {
                    newDir = currentDir === 'asc' ? 'desc' : 'asc';
                }
                headers.forEach(function(h) { h.removeAttribute('data-sort-dir'); h.classList.remove('sort-asc', 'sort-desc'); });
                th.setAttribute('data-sort-dir', newDir);
                th.classList.add(newDir === 'asc' ? 'sort-asc' : 'sort-desc');
                var thIndex = Array.from(th.parentNode.children).indexOf(th);
                rows.sort(function(a, b) {
                    var aCell = a.children[thIndex]; var bCell = b.children[thIndex];
                    var aVal = aCell ? (aCell.getAttribute('data-sort-value') || aCell.textContent.trim()) : '';
                    var bVal = bCell ? (bCell.getAttribute('data-sort-value') || bCell.textContent.trim()) : '';
                    if (sortType === 'number') {
                        aVal = parseFloat(aVal) || 0; bVal = parseFloat(bVal) || 0;
                        return newDir === 'asc' ? aVal - bVal : bVal - aVal;
                    } else {
                        aVal = aVal.toLowerCase(); bVal = bVal.toLowerCase();
                        if (aVal < bVal) return newDir === 'asc' ? -1 : 1;
                        if (aVal > bVal) return newDir === 'asc' ? 1 : -1;
                        return 0;
                    }
                });
                rows.forEach(function(row) { tbody.appendChild(row); });
            });
        });
        var defaultTh = table.querySelector('th[data-sort-default]');
        if (defaultTh) defaultTh.click();
    });
}

/* ---- Collect ---- */
function collectProject() {
    if (!confirm('Start collection for this project?')) return;
    apiFetch('/api/v1/collection/projects/' + PROJECT_ID, { method: 'POST' })
        .then(function(r) { return r ? r.json() : null; })
        .then(function(data) {
            if (data) showFlash(data.message || 'Collection started');
        })
        .catch(function(e) { showFlash('Error: ' + e, 'error'); });
}

/* ---- Modal helpers ---- */
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    document.body.style.overflow = '';
}

function closeModalOverlay(event, modalId) {
    if (event.target === document.getElementById(modalId)) closeModal(modalId);
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') { closeModal('serpModal'); closeModal('gscModal'); }
});

/* ---- SERP Modal ---- */
async function showSerp(keywordId, engine) {
    var modal = document.getElementById('serpModal');
    var title = document.getElementById('serpModalTitle');
    var meta = document.getElementById('serpModalMeta');
    var body = document.getElementById('serpModalBody');

    title.textContent = 'SERP Top — Loading...';
    meta.textContent = '';
    body.innerHTML = '<p class="muted">Loading...</p>';
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';

    var resp = await apiFetch('/api/v1/serp/details/' + keywordId + '/' + engine);
    if (!resp) return;
    var data = await resp.json();

    if (!data.keyword) { title.textContent = 'Error'; body.innerHTML = '<p class="muted">Failed to load</p>'; return; }

    var engineLabel = engine.charAt(0).toUpperCase() + engine.slice(1);
    title.textContent = engineLabel + ': ' + data.keyword;
    meta.innerHTML = 'Date: <b>' + (data.date || 'N/A') + '</b>';

    if (!data.details || data.details.length === 0) {
        body.innerHTML = '<p class="muted">No SERP data available</p>';
        return;
    }

    var domain = (projectData && projectData.domain) ? projectData.domain.toLowerCase() : '';
    var html = '<table class="serp-table"><thead><tr><th>#</th><th>URL</th></tr></thead><tbody>';
    data.details.forEach(function(d) {
        var url = d.url || '';
        var isHighlight = domain && url.toLowerCase().indexOf(domain) !== -1;
        var cls = isHighlight ? ' class="serp-highlight"' : '';
        var displayUrl = url.length > 80 ? url.substring(0, 80) + '...' : url;
        html += '<tr' + cls + '><td class="serp-pos">' + d.position + '</td>';
        html += '<td><a href="' + url + '" target="_blank" rel="noopener">' + displayUrl + '</a></td></tr>';
    });
    html += '</tbody></table>';
    body.innerHTML = html;
}

/* ---- GSC Modal ---- */
async function showGsc(keywordId) {
    var modal = document.getElementById('gscModal');
    var title = document.getElementById('gscModalTitle');
    var meta = document.getElementById('gscModalMeta');
    var body = document.getElementById('gscModalBody');

    title.textContent = 'GSC — Loading...';
    meta.textContent = '';
    body.innerHTML = '<p class="muted">Loading...</p>';
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';

    var resp = await apiFetch('/api/v1/webmaster/gsc/' + keywordId);
    if (!resp) return;
    var data = await resp.json();

    title.textContent = 'GSC: ' + (data.keyword || '');

    if (!data.days || data.days.length === 0) {
        body.innerHTML = '<p class="muted">No GSC data available</p>';
        return;
    }

    var totalImp = data.days.reduce(function(s, d) { return s + d.impressions; }, 0);
    var totalClk = data.days.reduce(function(s, d) { return s + d.clicks; }, 0);
    meta.innerHTML = 'Days: <b>' + data.days.length + '</b> | Total impressions: <b>' + totalImp.toLocaleString() + '</b> | Total clicks: <b>' + totalClk.toLocaleString() + '</b>';

    var html = '<table class="serp-table"><thead><tr><th>Date</th><th>Position</th><th>URL</th><th>Imp</th><th>Clicks</th><th>CTR</th></tr></thead><tbody>';
    data.days.forEach(function(d) {
        var url = d.url || '';
        var displayUrl = url.length > 55 ? url.substring(0, 55) + '...' : url;
        html += '<tr><td class="gsc-date">' + d.date + '</td>';
        html += '<td class="serp-pos">' + (d.position > 0 ? d.position.toFixed(1) : '—') + '</td>';
        html += '<td><a href="' + url + '" target="_blank" rel="noopener" title="' + url + '">' + displayUrl + '</a></td>';
        html += '<td>' + d.impressions.toLocaleString() + '</td>';
        html += '<td>' + d.clicks.toLocaleString() + '</td>';
        html += '<td>' + d.ctr + '%</td></tr>';
    });
    html += '</tbody></table>';
    body.innerHTML = html;
}

/* ---- GSC Semantics ---- */
async function loadGscSemantics() {
    var btn = document.getElementById('gscSemBtn');
    var body = document.getElementById('gscSemanticsBody');
    btn.disabled = true;
    btn.textContent = 'Loading...';
    body.innerHTML = '<p class="muted">Fetching data from GSC API...</p>';

    var resp = await apiFetch('/api/v1/webmaster/gsc-semantics/' + PROJECT_ID);
    btn.disabled = false;
    btn.textContent = 'Reload';

    if (!resp) return;
    var data = await resp.json();

    if (data.error) {
        body.innerHTML = '<p class="muted" style="color:var(--danger);">' + data.error + '</p>';
        return;
    }

    if (!data.pages || data.pages.length === 0) {
        body.innerHTML = '<p class="muted">No additional queries found.</p>';
        return;
    }

    var totalQueries = 0;
    data.pages.forEach(function(p) { totalQueries += p.queries.length; });

    var html = '<p class="text-secondary" style="margin-bottom:1rem;">Found <b>' + totalQueries + '</b> additional queries on <b>' + data.pages.length + '</b> pages.</p>';
    data.pages.forEach(function(page) {
        var displayUrl = page.url.length > 90 ? page.url.substring(0, 90) + '...' : page.url;
        html += '<div class="gsc-sem-page"><div class="gsc-sem-page-url"><a href="' + page.url + '" target="_blank" rel="noopener">' + displayUrl + '</a> <span class="muted">(' + page.queries.length + ')</span></div>';
        html += '<table class="keywords-table gsc-sem-table"><thead><tr><th>Query</th><th>Position</th><th>Impressions</th><th>Clicks</th><th>CTR</th></tr></thead><tbody>';
        page.queries.forEach(function(q) {
            html += '<tr><td><code>' + q.query + '</code></td>';
            html += '<td><span class="pos-badge ' + (q.position <= 3 ? 'top3' : q.position <= 10 ? 'good' : q.position <= 30 ? 'medium' : 'poor') + '">' + q.position + '</span></td>';
            html += '<td>' + q.impressions.toLocaleString() + '</td><td>' + q.clicks.toLocaleString() + '</td><td>' + q.ctr + '%</td></tr>';
        });
        html += '</tbody></table></div>';
    });
    body.innerHTML = html;
}

/* ---- Main Tab Switching ---- */
function switchMainTab(tab) {
    currentMainTab = tab;
    document.querySelectorAll('.main-tab-btn').forEach(function(b) { b.classList.remove('active'); });
    event.target.classList.add('active');

    var serpEl = document.getElementById('serpSection');
    var llmEl = document.getElementById('llmSection');

    if (serpEl) serpEl.style.display = tab === 'serp' ? '' : 'none';
    if (llmEl) llmEl.style.display = tab === 'llm' ? '' : 'none';

    if (tab === 'llm') loadLlmSection();
}

/* ---- Metric Glossary & Tooltips ---- */
var GLOSSARY = {
    MentionRate: 'Доля ответов LLM, в которых бренд был упомянут. Формула: кол-во упоминаний / всего проверок',
    SOV: 'Доля упоминаний бренда среди всех упоминаний (бренд + конкуренты). Формула: упоминания бренда / все упоминания',
    TotalChecks: 'Количество проанализированных ответов LLM за последние 30 дней',
    TotalCost: 'Суммарная стоимость API-запросов к LLM-провайдерам',
    MentionByProvider: 'Частота упоминаний бренда в ответах каждого LLM-провайдера. SOV — доля голоса по данному провайдеру',
    CompSOV: 'Доля упоминаний каждого конкурента среди всех упоминаний. Показаны бренды, дающие 80% суммарной доли',
    MentionOverTime: 'Динамика частоты упоминаний бренда по провайдерам за выбранный период',
};

function tip(key, label) {
    var text = GLOSSARY[key] || key;
    return '<span class="term-tip" data-tip="' + escapeHtml(text) + '">' + (label || key)
        + '<svg class="term-tip__icon" viewBox="0 0 16 16" fill="currentColor">'
        + '<circle cx="8" cy="8" r="7" fill="none" stroke="currentColor" stroke-width="1.2"/>'
        + '<text x="8" y="12" text-anchor="middle" font-size="11" font-weight="700">?</text></svg></span>';
}

/* ---- LLM Section ---- */
async function loadLlmSection() {
    var container = document.getElementById('llmContent');
    if (!container) return;

    // Load dashboard + queries + categories in parallel
    var catParam = currentCategory ? '&category=' + encodeURIComponent(currentCategory) : '';
    var [dashResp, queriesResp, catResp] = await Promise.all([
        apiFetch('/api/v1/llm/dashboard/' + PROJECT_ID + '?days=30' + catParam + (sovDetailLevel ? '&detail_level=' + sovDetailLevel : '')),
        apiFetch('/api/v1/projects/' + PROJECT_ID + '/llm-queries/?limit=200'),
        apiFetch('/api/v1/llm/categories/' + PROJECT_ID),
    ]);

    var dashData = dashResp ? await dashResp.json() : null;
    var queriesData = queriesResp ? await queriesResp.json() : null;
    var catData = catResp ? await catResp.json() : null;
    llmDashData = dashData;

    var html = '';

    // Scenario filter dropdown (only if categories exist)
    if (catData && catData.categories && catData.categories.length > 0) {
        html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:0.75rem;">';
        html += '<label style="color:#a0aec0;font-size:0.85rem;white-space:nowrap;">Scenario:</label>';
        html += '<select id="llmCategorySelect" onchange="switchCategory(this.value)" style="min-width:180px;">';
        html += '<option value="">All Scenarios</option>';
        catData.categories.forEach(function(cat) {
            var sel = (cat === currentCategory) ? ' selected' : '';
            html += '<option value="' + escapeHtml(cat) + '"' + sel + '>' + escapeHtml(cat) + '</option>';
        });
        html += '</select></div>';
    }

    // Full dashboard link
    html += '<div style="display:flex;justify-content:flex-end;gap:8px;margin-bottom:0.75rem;">';
    html += '<a href="/project/' + PROJECT_ID + '/prompts" class="btn btn-sm btn-ghost">';
    html += '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';
    html += ' Manage Prompts</a>';
    html += '<a href="/project/' + PROJECT_ID + '/competitors" class="btn btn-sm btn-ghost">';
    html += '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>';
    html += ' Competitors</a>';
    html += '<a href="/project/' + PROJECT_ID + '/llm-dashboard" class="btn btn-primary btn-sm">';
    html += '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>';
    html += ' Open Full Dashboard</a></div>';

    // Stats cards
    if (dashData) {
        html += '<div class="llm-stats-grid">';
        html += renderStatCard(tip('MentionRate', 'Brand Mention Rate'), formatPct(dashData.brand_mention_rate));
        html += renderStatCard(tip('SOV', 'Share of Voice'), formatPct(dashData.sov));
        html += renderStatCard(tip('TotalChecks', 'Total Checks'), dashData.total_checks);
        if (isAdmin()) html += renderStatCard(tip('TotalCost', 'Total Cost'), '$' + dashData.total_cost_usd.toFixed(2));
        html += '</div>';

        // Provider breakdown
        if (Object.keys(dashData.mention_rate_by_provider).length > 0) {
            html += '<div class="card" style="margin-top:1rem;"><h3 style="margin-bottom:0.75rem;">' + tip('MentionByProvider', 'Mention Rate by Provider') + '</h3>';
            html += '<div class="provider-bars">';
            var providerOrder = ['yandexgpt', 'deepseek', 'perplexity', 'chatgpt', 'gemini', 'gigachat'];
            providerOrder.forEach(function(prov) {
                if (!(prov in dashData.mention_rate_by_provider)) return;
                var rate = dashData.mention_rate_by_provider[prov];
                var sovVal = dashData.sov_by_provider[prov] || 0;
                html += '<div class="provider-bar-row">';
                html += '<span class="provider-name">' + prov + '</span>';
                html += '<div class="bar-container"><div class="bar-fill" style="width:' + (rate * 100) + '%;background:var(--accent);"></div></div>';
                html += '<span class="bar-value">' + formatPct(rate) + '</span>';
                html += '<span class="bar-label" style="margin-left:8px;color:#a0aec0;">SOV: ' + formatPct(sovVal) + '</span>';
                html += '</div>';
            });
            html += '</div></div>';
        }

        // Competitor SOV — rendered via function for provider filtering
        if (dashData.competitor_sov && Object.keys(dashData.competitor_sov).length > 0) {
            html += '<div class="card" style="margin-top:1rem;">';
            html += '<div id="competitorSovSection"></div>';
            html += '</div>';
        }
    }

    // Chart section
    html += '<div class="card" style="margin-top:1rem;">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;">';
    html += '<h3>' + tip('MentionOverTime', 'Mention Rate Over Time') + '</h3>';
    html += '<select id="llmChartDays" onchange="loadLlmChart()">';
    html += '<option value="7">7 days</option><option value="30" selected>30 days</option><option value="90">90 days</option>';
    html += '</select></div>';
    html += '<div class="chart-container"><canvas id="llmMentionChart"></canvas></div></div>';

    // LLM Queries table
    html += '<div class="card" style="margin-top:1rem;">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;">';
    html += '<h3>LLM Queries (' + (queriesData ? queriesData.total : 0) + ')</h3>';
    html += '<button class="btn btn-sm btn-primary" onclick="showAddLlmQueryForm()">Add Queries</button></div>';
    html += '<div id="llmAddQueryForm" style="display:none;margin-bottom:1rem;">';
    html += '<textarea id="llmNewQueries" rows="4" placeholder="Enter queries, one per line..." style="width:100%;margin-bottom:0.5rem;"></textarea>';
    html += '<div style="display:flex;gap:8px;align-items:center;">';
    html += '<input type="text" id="llmTargetBrand" placeholder="Target brand (optional)" style="flex:1;">';
    html += '<input type="text" id="llmCompetitors" placeholder="Competitors (comma-separated)" style="flex:1;">';
    html += '<select id="llmQueryType"><option value="brand_check">Brand Check</option><option value="comparison">Comparison</option><option value="recommendation">Recommendation</option><option value="custom">Custom</option></select>';
    html += '<button class="btn btn-primary" onclick="addLlmQueries()">Add</button></div></div>';

    if (queriesData && queriesData.items && queriesData.items.length > 0) {
        html += '<div class="table-wrapper"><table class="keywords-table"><thead><tr>';
        html += '<th>Query</th><th>Type</th><th>Brand</th><th>Active</th><th>Actions</th>';
        html += '</tr></thead><tbody>';
        queriesData.items.forEach(function(q) {
            html += '<tr>';
            html += '<td><code>' + q.query_text + '</code></td>';
            html += '<td><span class="badge">' + q.query_type + '</span></td>';
            html += '<td>' + (q.target_brand || '—') + '</td>';
            html += '<td>' + (q.is_active ? '<span class="match-ok">Yes</span>' : '<span class="match-no">No</span>') + '</td>';
            html += '<td><button class="btn btn-sm btn-danger" onclick="deleteLlmQuery(' + q.id + ')">Del</button></td>';
            html += '</tr>';
        });
        html += '</tbody></table></div>';
    } else {
        html += '<p class="muted">No LLM queries configured. Add queries to start tracking.</p>';
    }
    html += '</div>';

    // Top Cited URLs
    if (dashData && dashData.top_cited_urls && dashData.top_cited_urls.length > 0) {
        html += '<div class="card" style="margin-top:1rem;"><h3 style="margin-bottom:0.75rem;">Top Cited URLs</h3>';
        html += '<div class="table-wrapper"><table class="keywords-table"><thead><tr><th>URL</th><th>Citations</th></tr></thead><tbody>';
        dashData.top_cited_urls.forEach(function(c) {
            var displayUrl = c.url.length > 70 ? c.url.substring(0, 70) + '...' : c.url;
            html += '<tr><td><a href="' + c.url + '" target="_blank" rel="noopener">' + displayUrl + '</a></td>';
            html += '<td>' + c.count + '</td></tr>';
        });
        html += '</tbody></table></div></div>';
    }

    // Recent responses
    html += '<div class="card" style="margin-top:1rem;">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;">';
    html += '<h3>Recent Responses</h3>';
    html += '<select id="llmDetailProvider" onchange="loadLlmDetails()">';
    html += '<option value="">All Providers</option>';
    html += '<option value="chatgpt">ChatGPT</option><option value="deepseek">DeepSeek</option>';
    html += '<option value="perplexity">Perplexity</option><option value="yandexgpt">YandexGPT</option>';
    html += '<option value="gemini">Gemini</option><option value="gigachat">GigaChat</option>';
    html += '</select></div>';
    html += '<div id="llmDetailsBody"><p class="muted">Loading...</p></div></div>';

    container.innerHTML = html;
    renderCompetitorSov(currentSovProvider);
    loadLlmChart();
    loadLlmDetails();
}

function renderStatCard(label, value) {
    return '<div class="stat-card">'
        + '<div class="stat-card-value">' + value + '</div>'
        + '<div class="stat-card-label">' + label + '</div></div>';
}

function formatPct(val) {
    return (val * 100).toFixed(1) + '%';
}

function renderCompetitorSov(provider) {
    var section = document.getElementById('competitorSovSection');
    if (!section || !llmDashData) return;

    var dashData = llmDashData;
    var competitorSov = dashData.competitor_sov;
    var brandSov = dashData.sov;
    if (provider && dashData.competitor_sov_by_provider && dashData.competitor_sov_by_provider[provider]) {
        competitorSov = dashData.competitor_sov_by_provider[provider];
        brandSov = dashData.sov_by_provider && dashData.sov_by_provider[provider] != null
            ? dashData.sov_by_provider[provider] : 0;
    } else if (provider) {
        // Provider selected but no data for it
        competitorSov = {};
        brandSov = dashData.sov_by_provider && dashData.sov_by_provider[provider] != null
            ? dashData.sov_by_provider[provider] : 0;
    }

    var html = '';
    // Header with dropdown
    var hasSubBrands = Object.keys(competitorSov).some(function(k) { return k.indexOf('::') !== -1; });
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;flex-wrap:wrap;gap:8px;">';
    html += '<h3 style="margin:0;">' + tip('CompSOV', 'Competitor Share of Voice') + '</h3>';
    html += '<div style="display:flex;align-items:center;gap:8px;">';
    // Provider dropdown
    var providers = Object.keys(dashData.mention_rate_by_provider || {}).sort();
    if (providers.length > 1) {
        html += '<select onchange="switchSovProvider(this.value)" style="min-width:130px;">';
        html += '<option value=""' + (!provider ? ' selected' : '') + '>Все LLM</option>';
        providers.forEach(function(p) {
            html += '<option value="' + escapeHtml(p) + '"' + (p === provider ? ' selected' : '') + '>' + escapeHtml(p) + '</option>';
        });
        html += '</select>';
    }
    if (hasSubBrands || sovDetailLevel === 'detailed') {
        var btnLabel = sovDetailLevel === 'detailed' ? 'Roll-up View' : 'Show Sub-Brands';
        html += '<button class="btn btn-sm btn-ghost" onclick="switchSovDetail()">' + btnLabel + '</button>';
    }
    html += '</div></div>';

    // Bars
    if (Object.keys(competitorSov).length === 0 && brandSov === 0) {
        html += '<p class="muted">Нет данных по этому провайдеру.</p>';
        section.innerHTML = html;
        return;
    }
    html += '<div class="provider-bars">';
    var sovEntries = Object.entries(competitorSov).map(function(e) {
        var isSubBrand = e[0].indexOf('::') !== -1;
        var parentName = isSubBrand ? e[0].split('::')[0] : null;
        var subName = isSubBrand ? e[0].split('::')[1] : null;
        var displayName = isSubBrand ? subName : e[0];
        var isBrandSub = parentName === '__brand__';
        return { key: e[0], name: displayName, sov: e[1], isBrand: false, isSubBrand: isSubBrand, isBrandSub: isBrandSub, parentName: parentName };
    });
    sovEntries.push({ key: '__brand__', name: projectData.brand_name || 'Your Brand', sov: brandSov, isBrand: true, isSubBrand: false, isBrandSub: false, parentName: null });
    sovEntries.sort(function(a, b) {
        if (!a.isSubBrand && !b.isSubBrand) return b.sov - a.sov;
        if (a.isSubBrand && !b.isSubBrand) {
            if ((a.isBrandSub && b.isBrand) || a.parentName === b.key) return 1;
            return b.sov - a.sov;
        }
        if (!a.isSubBrand && b.isSubBrand) {
            if ((b.isBrandSub && a.isBrand) || b.parentName === a.key) return -1;
            return b.sov - a.sov;
        }
        return b.sov - a.sov;
    });
    // 80% cumulative SOV cutoff
    var totalSOV = 0;
    for (var ti = 0; ti < sovEntries.length; ti++) {
        if (!sovEntries[ti].isSubBrand) totalSOV += sovEntries[ti].sov;
    }
    var sovThreshold = totalSOV * 0.80;
    var cumSOV = 0;
    var cutoffIdx = sovEntries.length;
    var visibleParentKeys = new Set();
    for (var si = 0; si < sovEntries.length; si++) {
        var se = sovEntries[si];
        if (se.isSubBrand) continue;
        cumSOV += se.sov;
        visibleParentKeys.add(se.key);
        if (cumSOV >= sovThreshold) {
            cutoffIdx = si + 1;
            while (cutoffIdx < sovEntries.length && sovEntries[cutoffIdx].isSubBrand && visibleParentKeys.has(sovEntries[cutoffIdx].parentName)) {
                cutoffIdx++;
            }
            break;
        }
    }
    var hiddenCount = sovEntries.length - cutoffIdx;
    var sovChartId = 'sovChart_' + Date.now();
    var renderSovRow = function(entry) {
        var indent = entry.isSubBrand ? 'padding-left:24px;' : '';
        var nameStyle = '';
        var barColor = '#f87171';
        if (entry.isBrand) {
            nameStyle = 'color:var(--accent);font-weight:600;';
            barColor = 'var(--accent)';
        } else if (entry.isBrandSub) {
            nameStyle = 'color:var(--accent);font-size:0.85rem;opacity:0.8;';
            barColor = 'var(--accent)';
        } else if (entry.isSubBrand) {
            nameStyle = 'font-size:0.85rem;opacity:0.8;';
        }
        var row = '<div class="provider-bar-row" style="' + indent + '">';
        row += '<span class="provider-name" style="' + nameStyle + '">' + (entry.isSubBrand ? '↳ ' : '') + escapeHtml(entry.name) + '</span>';
        row += '<div class="bar-container"><div class="bar-fill" style="width:' + (entry.sov * 100) + '%;background:' + barColor + ';"></div></div>';
        row += '<span class="bar-value">' + formatPct(entry.sov) + '</span></div>';
        return row;
    };
    for (var vi = 0; vi < Math.min(cutoffIdx, sovEntries.length); vi++) {
        html += renderSovRow(sovEntries[vi]);
    }
    if (hiddenCount > 0) {
        html += '<div id="' + sovChartId + '_more" style="display:none;">';
        for (var hi = cutoffIdx; hi < sovEntries.length; hi++) {
            html += renderSovRow(sovEntries[hi]);
        }
        html += '</div>';
        html += '<button class="btn btn-sm btn-ghost" style="margin-top:0.5rem;width:100%;text-align:center;" '
              + 'onclick="var el=document.getElementById(\'' + sovChartId + '_more\');var b=this;'
              + 'if(el.style.display===\'none\'){el.style.display=\'block\';b.textContent=\'Collapse\';}else{el.style.display=\'none\';b.textContent=\'Show all (' + hiddenCount + ' more)\';}">'
              + 'Show all (' + hiddenCount + ' more)</button>';
    }
    html += '</div>';
    section.innerHTML = html;
}

function switchSovProvider(provider) {
    currentSovProvider = provider;
    renderCompetitorSov(provider);
}

function switchCategory(cat) {
    currentCategory = cat;
    loadLlmSection();
}

function switchSovDetail() {
    sovDetailLevel = sovDetailLevel === 'detailed' ? '' : 'detailed';
    loadLlmSection();
}

async function loadLlmChart() {
    var daysEl = document.getElementById('llmChartDays');
    var days = daysEl ? daysEl.value : '30';
    var catParam = currentCategory ? '&category=' + encodeURIComponent(currentCategory) : '';

    var resp = await apiFetch('/api/v1/llm/chart/' + PROJECT_ID + '?days=' + days + catParam);
    if (!resp) return;
    var data = await resp.json();

    if (llmChartInstance) {
        llmChartInstance.destroy();
        llmChartInstance = null;
    }

    var ctx = document.getElementById('llmMentionChart');
    if (!ctx) return;

    var datasets = data.datasets.map(function(ds, i) {
        var color = COLORS[i % COLORS.length];
        return {
            label: ds.label,
            data: ds.data.map(function(v) { return v !== null ? v * 100 : null; }),
            borderColor: color,
            backgroundColor: color + '20',
            fill: false,
            tension: 0.3,
            pointRadius: 3,
            pointHoverRadius: 6,
            borderWidth: 2,
            spanGaps: true,
        };
    });

    llmChartInstance = new Chart(ctx, {
        type: 'line',
        data: { labels: data.labels, datasets: datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
                y: {
                    min: 0, max: 100,
                    title: { display: true, text: 'Mention Rate (%)', color: '#a0aec0' },
                    ticks: { callback: function(v) { return v + '%'; }, color: '#a0aec0' },
                    grid: { color: '#2d3748' },
                },
                x: {
                    title: { display: true, text: 'Date', color: '#a0aec0' },
                    ticks: { maxRotation: 45, maxTicksLimit: 15, color: '#a0aec0' },
                    grid: { color: '#2d3748' },
                },
            },
            plugins: {
                tooltip: {
                    mode: 'index', intersect: false,
                    callbacks: { label: function(ctx) { var v = ctx.parsed.y; return v === null ? ctx.dataset.label + ': no data' : ctx.dataset.label + ': ' + v.toFixed(1) + '%'; } },
                },
                legend: { position: 'bottom', labels: { boxWidth: 20, boxHeight: 2, padding: 15, font: { size: 12 }, color: '#a0aec0' } },
            },
            interaction: { mode: 'index', intersect: false },
        },
    });
}

async function loadLlmDetails() {
    var body = document.getElementById('llmDetailsBody');
    if (!body) return;
    body.innerHTML = '<p class="muted">Loading...</p>';

    var provEl = document.getElementById('llmDetailProvider');
    var params = '?days=7&limit=20';
    if (provEl && provEl.value) params += '&provider=' + provEl.value;
    if (currentCategory) params += '&category=' + encodeURIComponent(currentCategory);

    var resp = await apiFetch('/api/v1/llm/details/' + PROJECT_ID + params);
    if (!resp) return;
    var data = await resp.json();

    if (!data.items || data.items.length === 0) {
        body.innerHTML = '<p class="muted">No recent responses.</p>';
        return;
    }

    var html = '<div class="table-wrapper"><table class="keywords-table"><thead><tr>';
    html += '<th>Date</th><th>Provider</th><th>Mentioned</th><th>Type</th><th>Tokens</th><th>Cost</th><th></th>';
    html += '</tr></thead><tbody>';
    data.items.forEach(function(item) {
        html += '<tr>';
        html += '<td>' + item.date + '</td>';
        html += '<td><span class="badge">' + item.llm_provider + '</span></td>';
        html += '<td>' + (item.brand_mentioned ? '<span class="match-ok">Yes</span>' : '<span class="match-no">No</span>') + '</td>';
        html += '<td>' + item.mention_type + '</td>';
        html += '<td>' + (item.response_tokens || '—') + '</td>';
        html += '<td>' + (item.cost_usd ? '$' + item.cost_usd.toFixed(4) : '—') + '</td>';
        html += '<td><button class="btn btn-sm" onclick="showLlmResponse(' + item.id + ', ' + item.llm_query_id + ')">View</button></td>';
        html += '</tr>';
    });
    html += '</tbody></table></div>';
    if (data.total > 20) html += '<p class="muted" style="margin-top:0.5rem;">Showing 20 of ' + data.total + ' responses.</p>';
    body.innerHTML = html;
}

async function showLlmResponse(snapshotId, queryId) {
    var modal = document.getElementById('llmResponseModal');
    var title = document.getElementById('llmResponseModalTitle');
    var meta = document.getElementById('llmResponseModalMeta');
    var body = document.getElementById('llmResponseModalBody');

    title.textContent = 'LLM Response';
    meta.textContent = '';
    body.innerHTML = '<p class="muted">Loading...</p>';
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';

    var resp = await apiFetch('/api/v1/llm/details/' + PROJECT_ID + '?query_id=' + queryId + '&days=90&limit=1');
    if (!resp) return;
    var data = await resp.json();

    if (!data.items || data.items.length === 0) {
        body.innerHTML = '<p class="muted">Response not found.</p>';
        return;
    }

    var item = data.items[0];
    title.textContent = item.llm_provider + ' — ' + item.date;
    meta.innerHTML = 'Model: <b>' + item.llm_model + '</b> | Tokens: <b>' + (item.response_tokens || '—') + '</b> | Cost: <b>$' + (item.cost_usd || 0).toFixed(4) + '</b>';

    var html = '';
    if (item.mention_context) {
        html += '<div style="background:#1e293b;padding:12px;border-radius:8px;margin-bottom:12px;">';
        html += '<strong>Mention Context:</strong><br><em>' + item.mention_context + '</em></div>';
    }
    if (item.cited_urls && item.cited_urls.length > 0) {
        html += '<div style="margin-bottom:12px;"><strong>Cited URLs:</strong><ul style="margin:4px 0;">';
        item.cited_urls.forEach(function(u) {
            html += '<li><a href="' + u + '" target="_blank" rel="noopener">' + u + '</a></li>';
        });
        html += '</ul></div>';
    }
    if (item.raw_response) {
        html += '<div style="margin-top:12px;"><strong>Full Response:</strong>';
        html += '<pre style="background:#0f172a;padding:12px;border-radius:8px;white-space:pre-wrap;word-break:break-word;max-height:400px;overflow-y:auto;font-size:0.85rem;">' + escapeHtml(item.raw_response) + '</pre></div>';
    }
    body.innerHTML = html;
}

function escapeHtml(str) {
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

/* ---- LLM Query Management ---- */
function showAddLlmQueryForm() {
    var form = document.getElementById('llmAddQueryForm');
    form.style.display = form.style.display === 'none' ? '' : 'none';
}

async function addLlmQueries() {
    var text = document.getElementById('llmNewQueries').value.trim();
    if (!text) return;
    var lines = text.split('\n').map(function(l) { return l.trim(); }).filter(function(l) { return l; });
    var brand = document.getElementById('llmTargetBrand').value.trim() || null;
    var comps = document.getElementById('llmCompetitors').value.trim();
    var competitors = comps ? comps.split(',').map(function(c) { return c.trim(); }).filter(function(c) { return c; }) : null;
    var qType = document.getElementById('llmQueryType').value;

    var queries = lines.map(function(l) {
        return { query_text: l, query_type: qType, target_brand: brand, competitors: competitors };
    });

    var resp = await apiFetch('/api/v1/projects/' + PROJECT_ID + '/llm-queries/', {
        method: 'POST',
        body: JSON.stringify({ queries: queries }),
    });
    if (resp && resp.ok) {
        var data = await resp.json();
        showFlash('Added ' + data.created + ' queries' + (data.skipped ? ', ' + data.skipped + ' skipped' : ''));
        document.getElementById('llmNewQueries').value = '';
        loadLlmSection();
    } else if (resp) {
        var err = await resp.json();
        showFlash(err.detail || 'Failed to add queries', 'error');
    }
}

async function deleteLlmQuery(queryId) {
    if (!confirm('Delete this LLM query?')) return;
    var resp = await apiFetch('/api/v1/projects/' + PROJECT_ID + '/llm-queries/' + queryId, { method: 'DELETE' });
    if (resp && (resp.ok || resp.status === 204)) {
        showFlash('Query deleted');
        loadLlmSection();
    }
}

/* ---- LLM Collect ---- */
function collectLlm() {
    if (!confirm('Start LLM collection for this project?')) return;
    apiFetch('/api/v1/collection/projects/' + PROJECT_ID + '/llm', { method: 'POST' })
        .then(function(r) { return r ? r.json() : null; })
        .then(function(data) {
            if (data) showFlash(data.message || 'LLM collection started');
        })
        .catch(function(e) { showFlash('Error: ' + e, 'error'); });
}

document.addEventListener('DOMContentLoaded', loadProject);
</script>
{% endif %}
{% endblock %}
